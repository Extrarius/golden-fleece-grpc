version: '3'

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
vars:
  BIN_DIR: '{{.ROOT_DIR}}/bin'
  EASYP: '{{.BIN_DIR}}/easyp'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  PROTOC_GEN_VALIDATE: '{{.BIN_DIR}}/protoc-gen-validate'
  PROTOC_GEN_GRPC_GATEWAY: '{{.BIN_DIR}}/protoc-gen-grpc-gateway'
  PROTOC_GEN_OPENAPIV2: '{{.BIN_DIR}}/protoc-gen-openapiv2'
  SWAGGER_OUT: '{{.ROOT_DIR}}/pkg/api'
  # –ü—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ proxy.golang.org
  GOPROXY: 'https://goproxy.cn,https://goproxy.io,https://proxy.golang.org,direct'
  # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã –∏ –ª–∏–Ω—Ç–µ—Ä—ã
  GOFUMPT_VERSION: 'v0.8.0'
  GCI_VERSION: 'v0.13.6'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GOFUMPT: '{{.BIN_DIR}}/gofumpt'
  GCI: '{{.BIN_DIR}}/gci'
  GOLANGCI_LINT: '{{.BIN_DIR}}/golangci-lint'

tasks:
  install-tools:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (easyp, protoc-gen-go, protoc-gen-go-grpc, Gateway –ø–ª–∞–≥–∏–Ω—ã) –≤ ./bin/"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        [ -f {{.EASYP}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º easyp...'
          GOBIN={{.BIN_DIR}} go install github.com/easyp-tech/easyp/cmd/easyp@latest
        }
        [ -f {{.PROTOC_GEN_GO}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-go...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        }
        [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-go-grpc...'
          GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
        }
        [ -f {{.PROTOC_GEN_GRPC_GATEWAY}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-grpc-gateway...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@latest
        }
        [ -f {{.PROTOC_GEN_OPENAPIV2}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-openapiv2...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@latest
        }
    status:
      - test -x {{.EASYP}}
      - test -x {{.PROTOC_GEN_GO}}
      - test -x {{.PROTOC_GEN_GO_GRPC}}
      - test -x {{.PROTOC_GEN_GRPC_GATEWAY}}
      - test -x {{.PROTOC_GEN_OPENAPIV2}}

  mod-update:
    desc: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π proto —á–µ—Ä–µ–∑ easyp"
    deps: [ install-tools ]
    cmds:
      - '{{.EASYP}} mod update'

  mod-tidy:
    desc: "–û—á–∏—Å—Ç–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Go –º–æ–¥—É–ª—è (go mod tidy)"
    cmds:
      - go mod tidy

  install-validate:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc-gen-validate"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ protoc-gen-validate –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
      
      –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è runtime –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ buf.build/go/protovalidate,
      –Ω–æ protoc-gen-validate –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ü–µ–ª–µ–π.
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        [ -f {{.PROTOC_GEN_VALIDATE}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º protoc-gen-validate...'
          GOBIN={{.BIN_DIR}} go install github.com/bufbuild/protovalidate/tools/protoc-gen-validate@latest
        }
    status:
      - test -x {{.PROTOC_GEN_VALIDATE}}

  generate:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go –∫–æ–¥–∞ –∏–∑ proto —Ñ–∞–π–ª–æ–≤ (–≤–∫–ª—é—á–∞—è Gateway)"
    deps: [ install-tools, mod-update ]
    cmds:
      - |
        echo "üì¶ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π proto –∫–æ–¥ —á–µ—Ä–µ–∑ easyp..."
        {{.EASYP}} generate --path proto
      - |
        echo "üåê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º gRPC Gateway –∫–æ–¥ –∏ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é..."
        task generate:gateway

  generate:gateway:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è gRPC Gateway –∫–æ–¥–∞ –∏ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏"
    deps: [ install-tools, mod-update ]
    cmds:
      - |
        echo "üåê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º gRPC Gateway –∫–æ–¥ –∏ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ protoc –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º Docker
        PROTOC_CMD="protoc"
        if ! command -v protoc &> /dev/null; then
          if command -v docker &> /dev/null; then
            echo "‚ö†Ô∏è  protoc –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Docker..."
            PROTOC_CMD="docker run --rm -v $(pwd):/workspace -w /workspace namely/protoc-all:latest"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: protoc –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –í–∞—Ä–∏–∞–Ω—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
            echo "   1. Ubuntu/Debian: sudo apt install protobuf-compiler"
            echo "   2. Snap: sudo snap install protobuf"
            echo "   3. –°–∫–∞—á–∞—Ç—å –±–∏–Ω–∞—Ä–Ω–∏–∫: https://github.com/protocolbuffers/protobuf/releases"
            echo "   4. –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è protoc —á–µ—Ä–µ–∑ Docker"
            exit 1
          fi
        fi
        
        mkdir -p {{.SWAGGER_OUT}}
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏ –∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º —á–µ—Ä–µ–∑ go list
        GOOGLEAPIS_PATH=$(go list -m -f '{{.Dir}}' google.golang.org/genproto/googleapis/api 2>/dev/null || echo "")
        PROTOBUF_PATH=$(go list -m -f '{{.Dir}}' google.golang.org/protobuf 2>/dev/null || echo "")
        BUF_VALIDATE_PATH=$(go list -m -f '{{.Dir}}' buf.build/gen/go/bufbuild/protovalidate/protocolbuffers/go 2>/dev/null || echo "")
        GRPC_GATEWAY_PATH=$(go list -m -f '{{.Dir}}' github.com/grpc-ecosystem/grpc-gateway 2>/dev/null || echo "")
        
        # –ï—Å–ª–∏ googleapis –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞–ø—Ä—è–º—É—é, –∏—â–µ–º –≤ grpc-gateway –∏–ª–∏ —á–µ—Ä–µ–∑ find
        if [ -z "$GOOGLEAPIS_PATH" ] || [ ! -d "$GOOGLEAPIS_PATH/google/api" ]; then
          if [ -n "$GRPC_GATEWAY_PATH" ] && [ -d "$GRPC_GATEWAY_PATH/third_party/googleapis" ]; then
            GOOGLEAPIS_PATH="$GRPC_GATEWAY_PATH/third_party/googleapis"
          else
            # –ò—â–µ–º –≤ go/pkg/mod - –Ω—É–∂–µ–Ω –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥ (–Ω–∞ 3 —É—Ä–æ–≤–Ω—è –≤—ã—à–µ –æ—Ç annotations.proto)
            FOUND_PATH=$(find $HOME/go/pkg/mod -name "annotations.proto" -path "*/google/api/*" 2>/dev/null | head -1)
            if [ -n "$FOUND_PATH" ]; then
              GOOGLEAPIS_PATH=$(echo "$FOUND_PATH" | xargs dirname | xargs dirname | xargs dirname)
            fi
          fi
        fi
        
        # –ï—Å–ª–∏ buf/validate –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º —á–µ—Ä–µ–∑ find –≤ –ø—Ä–æ—Ç–æ–≤–∞–ª–∏–¥–∞—Ç–µ
        if [ -z "$BUF_VALIDATE_PATH" ] || [ ! -d "$BUF_VALIDATE_PATH/buf/validate" ]; then
          # –ò—â–µ–º –≤ github.com/bufbuild/protovalidate
          FOUND_VALIDATE=$(find $HOME/go/pkg/mod/github.com/bufbuild/protovalidate* -name "validate.proto" -path "*/buf/validate/*" 2>/dev/null | head -1)
          if [ -n "$FOUND_VALIDATE" ]; then
            # –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 3 —É—Ä–æ–≤–Ω—è –≤—ã—à–µ –æ—Ç validate.proto (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è protovalidate/)
            BUF_VALIDATE_PATH=$(echo "$FOUND_VALIDATE" | xargs dirname | xargs dirname | xargs dirname)
          fi
        fi
        
        # –°–æ–±–∏—Ä–∞–µ–º –ø—É—Ç–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
        INCLUDE_PATHS="-Iproto"
        
        # –î–æ–±–∞–≤–ª—è–µ–º googleapis
        if [ -n "$GOOGLEAPIS_PATH" ] && [ -d "$GOOGLEAPIS_PATH" ]; then
          INCLUDE_PATHS="$INCLUDE_PATHS -I$GOOGLEAPIS_PATH"
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º protobuf types
        if [ -n "$PROTOBUF_PATH" ]; then
          if [ -d "$PROTOBUF_PATH/types" ]; then
            INCLUDE_PATHS="$INCLUDE_PATHS -I$PROTOBUF_PATH/types"
          elif [ -d "$PROTOBUF_PATH" ]; then
            INCLUDE_PATHS="$INCLUDE_PATHS -I$PROTOBUF_PATH"
          fi
        fi
        
        # –î–æ–±–∞–≤–ª—è–µ–º buf/validate
        if [ -n "$BUF_VALIDATE_PATH" ] && [ -d "$BUF_VALIDATE_PATH" ]; then
          INCLUDE_PATHS="$INCLUDE_PATHS -I$BUF_VALIDATE_PATH"
        fi
        
        echo "   –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç–∏: $INCLUDE_PATHS"
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Gateway –∫–æ–¥ –∏ Swagger
        if command -v docker &> /dev/null && ! command -v protoc &> /dev/null; then
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è protoc
          echo "   –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è protoc..."
          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -v {{.BIN_DIR}}:/plugins \
            namely/protoc-all:latest \
            protoc $INCLUDE_PATHS \
            --plugin=protoc-gen-grpc-gateway=/plugins/protoc-gen-grpc-gateway \
            --grpc-gateway_out=logtostderr=true,paths=source_relative:pkg/proto \
            --plugin=protoc-gen-openapiv2=/plugins/protoc-gen-openapiv2 \
            --openapiv2_out=logtostderr=true:{{.SWAGGER_OUT}} \
            --openapiv2_opt=json_names_for_fields=false \
            proto/notes/v1/notes.proto
        else
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π protoc
          protoc $INCLUDE_PATHS \
            --plugin=protoc-gen-grpc-gateway={{.PROTOC_GEN_GRPC_GATEWAY}} \
            --grpc-gateway_out=logtostderr=true,paths=source_relative:pkg/proto \
            --plugin=protoc-gen-openapiv2={{.PROTOC_GEN_OPENAPIV2}} \
            --openapiv2_out=logtostderr=true:{{.SWAGGER_OUT}} \
            --openapiv2_opt=json_names_for_fields=false \
            proto/notes/v1/notes.proto
        fi
        
        echo "‚úÖ Gateway –∫–æ–¥ –∏ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"

  lint:
    desc: "–õ–∏–Ω—Ç–∏–Ω–≥ proto —Ñ–∞–π–ª–æ–≤"
    deps: [ install-tools ]
    cmds:
      - |
        echo "üîç –õ–∏–Ω—Ç–∏–Ω–≥ proto —Ñ–∞–π–ª–æ–≤..."
        {{.EASYP}} lint --path proto
        echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ proto —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"

  install-formatters:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã gci –∏ gofumpt –≤ ./bin"
    summary: |
      –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ gofumpt –∏ gci –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–Ω–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏.

      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        - gofumpt: –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ Go
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ Go
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        [ -f {{.GOFUMPT}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gofumpt {{.GOFUMPT_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install mvdan.cc/gofumpt@{{.GOFUMPT_VERSION}}
        }
        [ -f {{.GCI}} ] || {
          echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gci {{.GCI_VERSION}}...'
          GOBIN={{.BIN_DIR}} go install github.com/daixiang0/gci@{{.GCI_VERSION}}
        }
    status:
      - test -x {{.GOFUMPT}}
      - test -x {{.GCI}}

  format:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç gofumpt + gci"
    summary: |
      –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Å–µ Go-—Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º gofumpt –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
      –∏ gci –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤.

      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
        - gofumpt: –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        - gci: –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –≥—Ä—É–ø–ø–∞–º
    deps: [ install-formatters ]
    cmds:
      - |
        echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ gofumpt ..."
        find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' ! -path '*/pkg/proto/*' ! -path '*/_final/*' ! -path '*/notes-service/*' -exec {{.GOFUMPT}} -extra -w {} +
      - |
        echo "üéØ –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã —á–µ—Ä–µ–∑ gci ..."
        find . -type f -name '*.go' ! -path '*/vendor/*' ! -path '*/bin/*' ! -path '*/pkg/proto/*' ! -path '*/_final/*' ! -path '*/notes-service/*' -exec {{.GCI}} write -s standard -s default {} +

  install-golangci-lint:
    desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç golangci-lint –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
    summary: |
      –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ golangci-lint –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ bin.
      –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ —á–µ—Ä–µ–∑ go install.

      –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è: {{.GOLANGCI_LINT_VERSION}}
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        [ -f {{.GOLANGCI_LINT}} ] || {
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º golangci-lint {{.GOLANGCI_LINT_VERSION}}..."
          GOBIN={{.BIN_DIR}} go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}
        }
    status:
      - test -x {{.GOLANGCI_LINT}}

  lint:go:
    desc: "–ó–∞–ø—É—Å–∫–∞–µ—Ç golangci-lint –¥–ª—è Go –∫–æ–¥–∞"
    summary: |
      –ó–∞–ø—É—Å–∫–∞–µ—Ç –ª–∏–Ω—Ç–µ—Ä golangci-lint –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.
      –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º.
    deps: [ install-golangci-lint ]
    cmds:
      - |
        echo "üîç –õ–∏–Ω—Ç–∏–Ω–≥ Go –∫–æ–¥–∞..."
        {{.GOLANGCI_LINT}} run ./...
        echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ Go –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"

  run:
    desc: "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (gRPC + HTTP Gateway + Swagger UI –Ω–∞ –ø–æ—Ä—Ç—É 8080)"
    cmds:
      - go run cmd/server/main.go

  clean:
    desc: "–û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏"
    cmds:
      - rm -rf bin/
      - rm -rf pkg/proto/

  test:
    desc: "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
    cmds:
      - go test ./...

